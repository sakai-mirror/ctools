<project name="build-config" basedir="." default="info-instance" >

  <!--

   $Id$
   $HeadURL$

   Customize sakai.properties for each instance.

  -->

  <!-- 
       TTD:
  -->


  <target name="configInfo" >
    <echo>
      This customizes the configuration information for a particular build.  Targets in here should
      not be invoked directly but shoudl be invoked from the master build.xml.

      The configuration properties for this build are below.  They are usually gotten from a properties file for the build.

      build.configuration.svnurl = ${build.configuration.svnurl}
      build.configuration.configdir = ${build.configuration.configdir}
      build.configuration.revision = ${build.configuration.revision}
    </echo>
  </target>

  <property file="./project.properties" />
  <property name="instance-type.file" value="instance.${instance-type}.properties" />
  <property file="${instance-type.file}" />

  <target name="buildProperties" depends="copyConfig, editInstanceSakaiProperties"
	  description="copy and edit the sakai.properties files." />

  <target name="copyConfig">
    <echo> copy from config.dir: ${config.dir} </echo>
    <echo> copy to instances.dir: ${instances.dir} </echo>
    <echo> copy keystore: ${keystore.dir}/${keystore} </echo>
    <copy todir="${instances.dir}/${instance-type}">
      <fileset dir="${config.dir}">
	<exclude name="**/sakai.properties"/>
	<exclude name="**/.project" />
      </fileset>
    </copy>
    <copy todir="${instances.dir}/${instance-type}">
      <fileset dir="${keystore.dir}">
	<include name="${keystore}" />
      </fileset>
    </copy>
  </target>


  <target name="editInstanceSakaiProperties" >
    <echo> sakai.properties: ${sakai.properties} </echo>
    <echo> instance-type: ${instance-type} </echo>
    <echo> instances.dir: ${instances.dir}</echo>
    <echo> serverUrl: ${serverUrl} </echo>
    <echo> version.service: ${version.service} </echo>
    <echo> version.sakai: ${version.sakai} </echo>

    <!-- to add a new property to be customized add a new token filter
    entry below -->

    <copy file="${sakai.properties}" 
	  tofile="${instances.dir}/${instance-type}/sakai.properties" 
	  overwrite="true">

       <filterchain> 

	<tokenfilter>
	  <replaceregex pattern="^(serverUrl\s*=\s*).*" replace="\1${serverUrl}"/>
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(serverName\s*=\s*).*" replace="\1${serverName}"/>
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(loggedOutUrl\s*=\s*).*" replace="\1${loggedOutUrl}" />
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(bodyPath@org.sakaiproject.content.api.ContentHostingService\s*=\s*).*" replace="\1${bodyPath}"/>
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(version.service\s*=\s*).*" replace="\1${version.service}"/>
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(version.sakai\s*=\s*).*" replace="\1${version.sakai}"/>
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(bodyVolumes@org.sakaiproject.content.api.ContentHostingService\s*=\s*).*" replace="\1${bodyVolumes}"/>
	</tokenfilter>

	<tokenfilter>
<!-- storagePath@org.sakaiproject.archive.api.ArchiveService -->
	  <replaceregex pattern="^(storagePath@org.sakaiproject.archive.api.ArchiveService\s*=\s*).*" replace="\1${storagePath}"/>
<!--	  <replaceregex pattern="^(storagePath\s*=\s*).*" replace="\1${storagePath}"/> -->
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(skin.default\s*=\s*).*" replace="\1${skin.default}"/>
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(login.icon\s*=\s*).*" replace="\1${login.icon}"/>
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(bottomnav.1\s*=\s*).*" replace="\1${bottomnav.1}"/>
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(ui.service\s*=\s*).*" replace="\1${ui.service}"/>
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(smtp@org.sakaiproject.email.api.EmailService\s*=\s*).*" 
			replace="\1${smtp@org.sakaiproject.email.api.EmailService}" />
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(stealthTools@org.sakaiproject.tool.api.ActiveToolManager\s*=\s*).*" 
			replace="\1${stealthTools@org.sakaiproject.tool.api.ActiveToolManager}"/>
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(portal.error.email\s*=\s*).*" 
			replace="\1${portal.error.email}"/>
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(mail.support\s*=\s*).*" 
			replace="\1${mail.support}"/>
	</tokenfilter>

	<tokenfilter>
	  <replaceregex pattern="^(support.email\s*=\s*).*" 
			replace="\1${support.email}"/>
	</tokenfilter>


      </filterchain> 
    </copy>

  </target>

</project>
