<project name="build-patches" basedir="." default="info" >

  <!--

   $Id$
   $HeadURL$
   
   Apply patches to the code.  Note that the code has been exported, so that need to apply patch files.

  -->

  <!-- 
       TTD:
       
  -->

  <target name="applyPatchesInfo">
    <echo>
      Apply patches to the exported source.  Should also work for checked out source.
      Note that the naming convention for the patch files is to use the revisions required to 
      GENERATE the patch.  That means the first revision number will be 1 less than first revision
      with a change, so that those differences will be extracted.
      Note also that the patch should work in the environment of an extracted Sakai distribution.  
      The '/trunk' element may need to be removed from the path.
    </echo>
  </target>

  <!-- ================================================== -->
  <!--  -->
  <!-- ================================================== -->


  <!--
  <target name="applyPatches" depends="SAK-5548" />
  -->

  <target name="applyPatches" depends="applyPatches_2-2-1_p6" />

  <target name="applyPatches_none">
    <echo> No patches to apply </echo>
  </target>


  <!-- ================= -->
  <!-- old 2.2.0 patches -->
  <!-- ================= -->

  <target name="applyPatches_p3.old" >
    <!-- included -->
    <!-- <applyPatch patchFileName="SAK-5548.patch" /> -->
    <applyPatch patchFileName="SAK-5549.patch" />
    <applyPatch patchFileName="SAK-5551.patch" />
    <!-- included -->
    <!-- <applyPatch patchFileName="SAK-5580.patch" /> -->
    <applyPatch patchFileName="SAK-5655.patch" />
    <applyPatch patchFileName="SAK-5678.patch" />
  </target>

  <target name="applyPatches_p4" >
    <!-- included -->
    <!-- <applyPatch patchFileName="SAK-5548.patch" /> -->
    <applyPatch patchFileName="SAK-5549.patch" />
    <applyPatch patchFileName="SAK-5551.patch" />
    <!-- included -->
    <!-- <applyPatch patchFileName="SAK-5580.patch" /> -->
    <applyPatch patchFileName="SAK-5655.patch" />
    <applyPatch patchFileName="SAK-5678.patch" />



    <applyPatch patchFileName="SAK-5681.patch" />
    <!--  first hunk fails
    <applyPatch patchFileName="SAK-5756.patch" />
    -->
  </target>

  <target name="applyPatches_p5" >
    <echo> applying patch level ${patchLevel} </echo>
    <!-- included -->
    <!-- <applyPatch patchFileName="SAK-5548.patch" />  -->
    <applyPatch patchFileName="SAK-5549.patch" />
    <applyPatch patchFileName="SAK-5551.patch" />
    <!-- included -->
    <!-- <applyPatch patchFileName="SAK-5580.patch" />  -->
    <applyPatch patchFileName="SAK-5655.patch" />
    <applyPatch patchFileName="SAK-5678.patch" />
    <applyPatch patchFileName="SAK-5681.patch" />
    <!--  first hunk fails
    <applyPatch patchFileName="SAK-5756.patch" />
    -->
    <!-- Note that the patches should be applied in the revision
    order, not the number of the ticket.
    -->
    <applyPatch patchFileName="SAK-4393.patch" />
  </target>

  <!-- ================= -->
  <!--   2.2.1 patches   -->
  <!-- ================= -->

  <target name="applyPatches_2-2-1_p1" >
    <applyPatch patchFileName="SAK-5940.patch" />
  </target>

  <target name="applyPatches_2-2-1_p2" >
    <applyPatch patchFileName="SAK-5777.patch" />
    <applyPatch patchFileName="SAK-5940.patch" />
    <applyPatch patchFileName="SAK-6032.patch" />
    <applyPatch patchFileName="CT-659.patch" />

  </target>

  <target name="applyPatches_2-2-1_p3" >
    <applyPatch patchFileName="SAK-5777.patch" />
    <applyPatch patchFileName="SAK-5940.patch" />
    <applyPatch patchFileName="SAK-6032.patch" />
    <applyPatch patchFileName="CT-659.patch" />
    <applyPatch patchFileName="SAK-3564.patch" />
  </target>


    <!--
	applyPatches_2-2-1_p4
	By default we build from 2.2.1 Sakai tag and 
	most recent ctools source.  Since the ctools side of
	the change is in CTools source, but the Sakai side isn't
	in 2.2.1, we need to run either the patch (to add 
	this to 2.2.1, or the undo, to take it out of CTools.
	-->

    <!--
    <applyPatch patchFileName="SAK-3564.patch" />
    -->

  <target name="applyPatches_2-2-1_p4" >
    <echo message="applying patch set 2-2-1_p4" />
    <applyPatch patchFileName="SAK-5777.patch" />
    <applyPatch patchFileName="SAK-5940.patch" />
    <applyPatch patchFileName="SAK-6032.patch" />
    <applyPatch patchFileName="CT-659.patch" />
    <applyPatch patchFileName="SAK-3564.undo.patch" />
    <applyPatch patchFileName="SPEED.patch" />
  </target>

  <target name="applyPatches_2-2-1_p5" >
    <echo message="applying patch set 2-2-1_p5" />

    <applyPatch patchFileName="SAK-5777.patch" />
    <applyPatch patchFileName="SAK-5940.patch" />
    <applyPatch patchFileName="SAK-6032.patch" />
    <applyPatch patchFileName="CT-659.patch" />
    <applyPatch patchFileName="SAK-3564.patch" />
    <applyPatch patchFileName="SPEED.patch" />
    <applyPatch patchFileName="SAK-6127.patch" />
    <applyPatch patchFileName="SAK-6259.patch" />

    <!-- basic auth for rss -->
    <applyPatch patchFileName="SAK-4295-basicauth.java.patch" />
    <applyPatch patchFileName="SAK-4295-basicauth.patch" />
    <applyPatch patchFileName="SAK-4295b.patch" />
    <applyPatch patchFileName="SAK-6139.patch" />

    <applyPatch patchFileName="SAK-5295-6085-6210.patch" />

  </target>

<target name="applyPatches_2-2-1_p6" >
    <echo message="applying patch set 2-2-1_p6" />

    <applyPatch patchFileName="SAK-5777.patch" />
    <applyPatch patchFileName="SAK-5940.patch" />
    <applyPatch patchFileName="SAK-6032.patch" />
    <applyPatch patchFileName="CT-659.patch" />
    <applyPatch patchFileName="SAK-3564.patch" />
    <applyPatch patchFileName="SPEED.patch" />
    <applyPatch patchFileName="SAK-6127.patch" />
    <applyPatch patchFileName="SAK-6259.patch" />

    <!-- basic auth for rss -->
    <applyPatch patchFileName="SAK-4295-basicauth.java.patch" />
    <applyPatch patchFileName="SAK-4295-basicauth.patch" />
    <applyPatch patchFileName="SAK-4295b.patch" />
    <applyPatch patchFileName="SAK-6139.patch" />

    <applyPatch patchFileName="SAK-5295-6085-6210.patch" />

    <applyPatch patchFileName="SAK-5115.patch" />
    <applyPatch patchFileName="SAK-5705.patch" />

    <applyPatch patchFileName="SAK-6148.patch" />

    <applyPatch patchFileName="SAK-6319.patch" />
    <applyPatch patchFileName="SAK-6320.patch" />
    <applyPatch patchFileName="SAK-4549.patch" />

  </target>

  <!--
      <target name="applyPatchesTEST" >
      <echo message="test applying specific patches" />
      <applyPatch patchFileName="SAK-6320.patch" />
      </target>
  -->


  <!-- This command line works.
  patch -p0 /-/-ignore-whitespace /-/-dry-run /-/-input=../S.12711-12713.patch /-/-backup
  -->


  <macrodef name="applyPatch">
    <attribute name="patchFileName" />
    <sequential>
    <echo> applying patch @{patchFileName}</echo>
    <echo> patches.dir: ${patches.dir} </echo>
    <exec executable="patch"
	  dir="${build.dir}"
	  failonerror="true"
	  output="${logs.dir}/${ant.project.name}.log"
	  append="true">
      <arg value="-p0" />
      <arg value="--verbose" />
      <arg value ="--ignore-whitespace" />
      <!--
      <arg value="\-\-dry-run" /> 
      -->
      <arg value="--input=${patches.dir}/@{patchFileName}" />
      <!--      <arg value="\-\-backup" /> -->
      <arg value="--remove-empty-files" />
    </exec>
    </sequential>
  </macrodef>

</project>
