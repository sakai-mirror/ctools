#!/bin/bash # -*- sh -*-
# generate an externals file from an existing .externals file from SVN

# $HeadURL$
# $Id$
# take .externals file in svn, get the latest revision number for
# each entry in it.  Then write a file in the externals format:
# - A file with the exact revision number for each entry

# TTD:
# - 

echo <<EOF
Doesn't deal with the svn options on a line (e.g. --ignore-externals).
Loses comments.
Should document max revision.
EOF

URL=$1

if [ x$URL == x ]; then
    echo must specify a svn url to a directory with a .externals file or a local path name to any file in externals format.
    exit 1;
fi

## See if this is a local file or a remote url .externals file.

http_match_length=`expr "$URL" : 'http'`;

if [ "$http_match_length" -eq "0" ]; then
    file=$URL
elif [ "$http_match_length" -gt "0" ]; then
    #echo "http length: $http_match_length";
    svn cat $URL/.externals >| ./externals.tmp.svn.$$
    file=./externals.tmp.svn.$$
fi

# Take existing externals and create a script to get current revision numbers

# skip the commented lines
cat $file | perl -n -e 'next LINE if (/^\s*#/); m|(\S+).*(http.*)| && print "svn --limit 1 -q log $2\necho $1 -rREVISION $2\n"'  >| ./externals.tmp.1.$$

# create externals file with the exact revision for each reference.
echo "# " $(date) >| ./externals.exact

#set -x

# find the updated information and format as a .externals script.
source ./externals.tmp.1.$$ | perl -n -e 'chomp; if (m/r(\d+)\s/) {$R=$1}; if (m/https/i) {s/REVISION/$R/; print " $_\n"}' >> ./externals.exact

### Take out max revision processing since it doesn't respect the fact that different
### branches may be used.

#set -x

# # find and print the maximum revision number.
mv ./externals.exact ./externals.tmp.3.$$
cat  ./externals.tmp.3.$$ | perl -n -e 'BEGIN { $maxR = -1} chomp; if (m/r(\d+)\s/) {$R=$1}; if (m/https/i) {$maxR = ($R > $maxR ? $R : $maxR);} END { print "# maxR: $maxR\n";}' >| ./externals.tmp.4.$$
cat ./externals.tmp.4.$$ ./externals.tmp.3.$$ >| ./exernals.exact

# clean up
rm ./externals.tmp.*.$$
#end
